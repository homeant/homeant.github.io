<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="springBoot系列 - 集成JWT实现接口权限认证\n"><title>springBoot系列 - 集成JWT实现接口权限认证</title>
<link rel=canonical href=https://tianhui.xin/p/springboot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90jwt%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/><link rel=stylesheet href=/scss/style.min.ff3b8d603fba72cfbea59a04d44e5b626964947823918867ca736db0edf12ed5.css><meta property='og:title' content="springBoot系列 - 集成JWT实现接口权限认证"><meta property='og:description' content="springBoot系列 - 集成JWT实现接口权限认证\n"><meta property='og:url' content='https://tianhui.xin/p/springboot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90jwt%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/'><meta property='og:site_name' content='Codly Blog'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='springboot'><meta property='article:tag' content='Java'><meta property='article:published_time' content='2018-07-20T21:00:00+00:00'><meta property='article:modified_time' content='2018-07-20T21:00:00+00:00'><meta property='og:image' content='https://image.tianhui.xin/liveLearn/5/api-security.jpg'><meta name=twitter:title content="springBoot系列 - 集成JWT实现接口权限认证"><meta name=twitter:description content="springBoot系列 - 集成JWT实现接口权限认证\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://image.tianhui.xin/liveLearn/5/api-security.jpg'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar__hu10927481282854564545.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>Codly Blog</a></h1><h2 class=site-description>Someone has to do it.</h2></div></header><ol class=menu-social><li><a href=https://www.douyin.com/user/MS4wLjABAAAAb8DZ5sw76SjM890CLXJSktIPaVpI_-4Fkb8N22l3wes target=_blank title=Douyin rel=me><!doctype html><svg t="1731207376165" class="icon" viewBox="0 0 1024 1024" p-id="35376" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M109.056 513.536c0 223.232 180.736 404.48 404.48 404.48 223.232.0 404.48-180.736 404.48-404.48.0-223.232-181.248-404.48-404.48-404.48s-404.48 181.248-404.48 404.48z" fill="#170b1a" p-id="35377"/><path d="M513.024 370.176c.512-43.52.0-87.552.512-131.584h89.6c-.512 7.68 1.024 15.36 2.048 23.04h-66.048v356.352c.512 14.848-3.584 30.208-11.264 43.52-11.776 20.48-33.28 33.792-56.832 35.84-14.848 1.024-29.696-1.536-43.52-9.216-10.24-5.12-18.944-13.312-25.088-22.528 23.04 12.8 52.736 11.776 75.264-3.072 20.992-13.312 35.328-37.888 35.328-63.488V370.176zm148.48-25.088c12.288 7.68 26.624 13.824 40.96 16.896 8.704 2.048 16.896 3.072 26.112 3.072v19.968c-26.624-6.144-49.664-19.968-67.072-39.936z" fill="#25f4ee" p-id="35378"/><path d="M351.744 456.704c32.256-19.968 71.168-28.16 108.544-23.04v20.992c-10.24.512-19.968 1.536-29.696 3.584-24.064 5.12-47.104 14.848-67.072 29.696-20.992 15.872-37.376 37.376-49.152 61.44-11.264 23.04-16.384 48.128-15.872 73.728.0 27.648 7.68 55.296 20.992 79.36 6.144 11.264 13.312 22.016 22.528 31.232-18.944-13.312-35.328-31.232-46.592-51.2-15.872-27.136-23.552-58.368-23.04-89.6 1.024-28.672 9.216-57.344 24.576-81.92 14.336-21.504 32.256-40.448 54.784-54.272z" fill="#25f4ee" p-id="35379"/><path d="M539.136 261.12h66.56c2.56 12.8 7.168 25.088 12.8 36.352 9.216 17.92 22.528 33.792 39.424 44.032 1.024 1.024 2.048 1.536 3.072 3.072 17.408 19.968 41.472 34.304 67.584 39.936.512 23.04.0 47.104.0 70.144-43.52.512-87.552-13.312-123.392-39.424.0 55.808.0 111.616.512 167.936.0 7.168.512 14.848.0 22.528-2.048 27.136-10.24 53.76-24.064 77.312-11.776 20.48-27.648 38.912-46.592 52.736-24.576 18.432-54.272 28.16-84.992 29.184-15.36.512-31.232-.512-46.08-4.096-20.992-4.608-41.472-13.312-59.392-26.112l-1.024-1.024c-9.216-9.216-16.384-19.968-22.528-31.232-13.312-24.064-20.992-51.2-20.992-79.36-.512-25.088 5.12-51.2 15.872-73.728 11.264-24.064 27.648-45.568 49.152-61.44 19.968-14.848 42.496-25.088 67.072-29.696 9.728-2.048 19.968-3.072 29.696-3.584.512 9.216.0 17.92.512 26.624v45.056c-11.264-4.096-23.552-4.096-35.328-1.024-13.824 3.072-27.136 9.216-37.888 18.944-6.656 5.632-12.288 12.8-16.384 20.48-7.168 13.312-9.216 28.672-7.68 43.52 1.536 14.336 7.68 28.16 16.896 39.424 6.144 7.68 14.336 13.312 22.528 18.944 6.656 9.216 14.848 16.896 25.088 22.528 13.312 7.168 28.16 10.24 43.52 9.216 23.04-1.536 45.056-15.872 56.832-35.84 7.168-13.312 11.264-28.16 11.264-43.52-1.536-120.32-2.048-239.104-2.048-357.888z" fill="#fff" p-id="35380"/><path d="M605.696 261.12c7.68.512 15.36.0 23.552.0.0 26.112 8.192 51.712 23.04 73.216 2.048 3.072 4.096 5.12 5.632 7.168-16.896-10.752-30.72-26.624-39.424-44.032-5.12-10.752-10.24-23.04-12.8-36.352zm122.368 123.904c8.704 2.048 16.896 3.072 26.112 3.072v90.624c-44.032.512-88.576-14.336-124.416-40.448v179.2c.512 13.312-1.024 27.136-4.096 40.448-8.704 40.448-32.256 76.288-66.048 100.352-17.92 12.8-37.888 21.504-59.392 26.624-25.6 5.632-52.224 5.12-77.312-1.024-30.208-7.68-57.344-24.576-78.848-47.104 17.92 12.8 37.888 20.992 59.392 26.112 14.848 3.584 30.72 4.096 46.08 4.096 30.72-1.024 60.416-11.264 84.992-29.184 18.944-13.824 34.816-32.256 46.592-52.736 13.824-23.552 22.016-50.176 24.064-77.312.512-7.168.512-14.848.0-22.528-.512-55.808-.512-111.616-.512-167.936 35.328 25.6 79.36 39.424 123.392 39.424v-71.68z" fill="#fe2c55" p-id="35381"/><path d="M460.8 454.656c8.704.0 17.408.512 26.112 1.536v92.672c-12.288-4.096-26.624-4.608-39.424-1.536-24.576 5.12-45.056 24.064-53.248 47.616-8.704 23.04-5.12 50.688 9.728 70.144-8.704-5.12-16.384-11.264-22.528-18.944-9.216-11.264-15.36-25.088-16.896-39.424-1.536-14.848 1.024-30.208 7.68-43.52 4.096-7.68 9.728-14.848 16.384-20.48 11.264-9.216 24.576-14.848 37.888-18.944 11.776-3.072 24.064-3.072 35.328 1.024v-45.056c-1.024-7.168-.512-15.872-1.024-25.088z" fill="#fe2c55" p-id="35382"/></svg></a></li><li><a href=https://github.com/homeant target=_blank title=GitHub rel=me><!doctype html><svg t="1731206721410" class="icon" viewBox="0 0 1206 1024" p-id="14990" xmlns:xlink="http://www.w3.org/1999/xlink" width="235.546875" height="200"><path d="M139.995429 262.546286S17.700572 390.509715 38.948571 598.710857c21.248 208.237714 153.088 380.050286 592.749715 380.050286 439.625143.0 550.217143-229.485714 552.813714-418.230857 2.596571-188.672-82.395429-272.822857-122.294857-301.458286.0.0.256-135.460571-12.544-207.030857.0.0-67.657143-8.009143-213.76 75.702857.0.0-199.460571-19.492571-465.261714 2.377143.0.0-111.652571-74.605714-224.146286-94.134857.0.0-18.651429 117.467429-6.509714 226.56z" fill="#333" p-id="14991"/><path d="M336.859429 468.662857h545.499428s154.587429-17.371429 154.587429 235.52C1038.189715 926.756571 629.577143 912.384 629.577143 912.384s-447.488 17.773714-447.744-229.266286C181.248 460.032 336.859429 468.662857 336.859429 468.662857z" fill="#e2b89f" p-id="14992"/><path d="M832.621714 570.185143c35.072.0 63.524571 45.714286 63.524572 101.924571.0 56.32-28.452571 101.961143-63.524572 101.961143-35.035429.0-63.488-45.641143-63.488-101.961143-.036571-56.210286 28.452571-101.924571 63.488-101.924571z" fill="#9c584f" p-id="14993"/><path d="M832.621714 792.356571c-45.860571.0-81.773714-52.809143-81.773714-120.246857.0-67.401143 35.913143-120.210286 81.773714-120.210285 45.897143.0 81.810286 52.809143 81.810286 120.210285.0 67.437714-35.949714 120.246857-81.810286 120.246857zm0-203.885714c-21.394286.0-45.202286 34.340571-45.202285 83.638857.0 49.334857 23.808 83.675429 45.202285 83.675429s45.238857-34.340571 45.238857-83.675429c0-49.298286-23.844571-83.638857-45.238857-83.638857z" fill="#fff" p-id="14994"/><path d="M393.764571 570.185143c35.072.0 63.524571 45.714286 63.524572 101.924571.0 56.32-28.452571 101.961143-63.524572 101.961143-35.035429.0-63.488-45.641143-63.488-101.961143-.036571-56.210286 28.452571-101.924571 63.488-101.924571z" fill="#9c584f" p-id="14995"/><path d="M393.764571 792.356571c-45.860571.0-81.773714-52.809143-81.773714-120.246857.0-67.401143 35.913143-120.210286 81.773714-120.210285 45.860571.0 81.810286 52.809143 81.810286 120.210285.0 67.437714-35.949714 120.246857-81.810286 120.246857zm0-203.885714c-21.394286.0-45.202286 34.340571-45.202285 83.638857.0 49.334857 23.808 83.675429 45.202285 83.675429s45.238857-34.340571 45.238858-83.675429c0-49.298286-23.844571-83.638857-45.238858-83.638857z" fill="#fff" p-id="14996"/><path d="M587.922286 793.782857S606.171429 741.924571 628.48 790.528c0 0-16.713143 10.861714-10.422857 36.425143l52.224 19.968H552.155429l46.811428-21.028572s6.729143-38.619429-11.044571-32.109714z" fill="#9c584f" p-id="14997"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><!doctype html><svg t="1731208449587" class="icon" viewBox="0 0 1024 1024" p-id="46150" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M515.92192 543.55968m-343.94112.0a343.94112 343.94112.0 10687.88224.0 343.94112 343.94112.0 10-687.88224.0z" fill="#bed5e9" p-id="46151"/><path d="M515.65568 894.68416c-161.75104.0-301.80864-109.82912-340.58752-267.08992-46.32064-187.93984 68.87936-378.54208 256.8192-424.87808a352.58368 352.58368.0 0184.3008-10.28608c161.75104.0 301.80864 109.82912 340.58752 267.09504 46.32064 187.93984-68.87936 378.53696-256.8192 424.87296a352.6144 352.6144.0 01-84.3008 10.28608zm.53248-688.04096c-27.10528.0-54.3232 3.31776-80.896 9.87136-180.3264 44.46208-290.86208 227.34336-246.40512 407.67488 37.20192 150.89152 171.5712 256.2816 326.77376 256.2816 27.10528.0 54.3232-3.31776 80.896-9.87136 180.3264-44.45696 290.86208-227.34336 246.40512-407.66976-37.20704-150.90176-171.5712-256.28672-326.77376-256.28672z" fill="#6c0000" p-id="46152"/><path d="M511.73376 353.10592c-238.4384-8.4736-493.83424 37.88288-497.4848 140.5184-3.65056 102.62016 247.81312 166.99904 486.25152 175.47264 238.44352 8.47872 493.83936-37.88288 497.4848-140.50304 3.65056-102.6304-247.808-167.00928-486.25152-175.488zm465.99168 174.7712c-2.34496 65.87392-206.64832 132.3776-476.5696 122.78272-269.92128-9.59488-468.98688-90.43968-466.64704-156.3136 2.33984-65.87392 206.64832-132.39808 476.5696-122.8032s468.98688 90.46016 466.64704 156.33408z" fill="#6b0306" p-id="46153"/><path d="M232.87808 366.4384c-8.31488 10.16832-16.62976 26.64448-20.50048 34.81088 81.66912-18.63168 178.11456-24.59136 296.61696-20.3776 131.0976 4.6592 239.7184 21.62176 322.42688 50.0224-3.2-8.83712-14.17216-31.76448-18.02752-40.192-89.95328-26.81856-190.6688-50.91328-302.66368-54.89664-101.9392-3.61984-190.70976 14.10048-277.85216 30.63296z" fill="#bed5e9" p-id="46154"/><path d="M626.14528 640.2816m-88.576.0a88.576 88.576.0 10177.152.0 88.576 88.576.0 10-177.152.0z" fill="#ffc700" p-id="46155"/><path d="M626.2016 734.78656h-.01024c-1.12128.0-2.26816-.0256-3.39968-.06144-52.0704-1.85344-92.928-45.7216-91.08992-97.792 1.85344-52.24448 45.41952-93.01504 97.79712-91.0848 52.0704 1.85344 92.928 45.7216 91.08992 97.792a94.15168 94.15168.0 01-94.3872 91.14624zm-.11264-177.15712a82.31424 82.31424.0 00-82.53952 79.7184c-1.61792 45.5424 34.11456 83.9168 79.66208 85.54496l2.9952.0512a82.33472 82.33472.0 0082.53952-79.72352c1.61792-45.53728-34.11456-83.91168-79.66208-85.53472l-2.9952-.05632z" fill="#6c0000" p-id="46156"/><path d="M807.26528 251.19744m-18.83648.0a18.83648 18.83648.0 1037.67296.0 18.83648 18.83648.0 10-37.67296.0z" fill="#ffc700" p-id="46157"/><path d="M807.28064 275.95776l-.89088-.01536a24.80128 24.80128.0 01-23.87968-25.6256 24.6784 24.6784.0 0124.73472-23.8848c14.5408.50176 25.25184 11.99616 24.76544 25.64096a24.66816 24.66816.0 01-24.7296 23.8848zm.41984-37.67296c-7.43936.0-13.09696 5.47328-13.3376 12.44672a12.93312 12.93312.0 0012.44672 13.37344l.47616 5.92896v-5.92384a12.85632 12.85632.0 0012.88704-12.45184 12.93312 12.93312.0 00-12.44672-13.37344h-.0256z" fill="#6c0000" p-id="46158"/><path d="M109.1072 396.40064m-46.69952.0a46.69952 46.69952.0 1093.39904.0 46.69952 46.69952.0 10-93.39904.0z" fill="#ffc700" p-id="46159"/><path d="M109.12768 449.02912l-1.89952-.03584c-28.99968-1.03424-51.75808-25.46176-50.72896-54.45632a52.43904 52.43904.0 0152.56704-50.75456l1.89952.03584a52.2752 52.2752.0 0136.64896 16.72192 52.3008 52.3008.0 0114.08 37.73952 52.42368 52.42368.0 01-52.56704 50.74944zm-.05632-93.40416A40.61184 40.61184.0 0068.352 394.9568c-.79872 22.46656 16.83456 41.3952 39.296 42.19904l1.47968.0256a40.6016 40.6016.0 0040.71936-39.32672 40.51456 40.51456.0 00-10.89536-29.24544 40.5504 40.5504.0 00-28.40064-12.96384l-1.47968-.02048z" fill="#6c0000" p-id="46160"/><path d="M537.94304 203.50464c8.74496 2.21184-13.89568 24.84224-4.6336 37.26336 9.2672 12.42112 5.56032 11.68384 9.2672 12.42112 20.19328 4.03456 32.5888-13.88544 46.0032-10.85952 5.3504 1.20832 8.61184 12.75392 13.24544 25.17504s19.37408 9.35424 19.5072 14.6688c.20992 8.46848 5.89824 21.27872-3.36896 33.70496-9.2672 12.42112-40.14592 8.5504-47.72352 14.03392-10.0608 7.28576-90.76736-33.04448-36.92544 22.65088 5.41696 5.60128 29.11744-.31232 37.6064 6.4256 36.864 29.25056 36.51584-2.28352 45.77792 55.68512s-5.2992 69.69344-9.2672 74.53184c-22.6304 27.61216-31.96928 26.60864-35.49696 18.70848-4.608-10.3168 35.49696-35.27168 3.06688-55.97696L542.57152 431.232s-22.4768-16.00512-16.14848-25.79456c3.56864-5.52448 18.04288-16.8704-19.0208-49.9968s-53.62176 9.984-72.15104-31.42144-11.73504-51.28704-11.73504-80.27136-.68096-29.78304-.68096-29.78304 51.29216-26.59328 115.10784-10.46016z" fill="#ffec43" p-id="46161"/><path d="M578.4576 518.67136c-3.06688.0-8.68864-1.08032-11.92448-8.34048-2.88256-6.4512 1.65376-13.14304 6.44608-20.22912 4.72064-6.95808 10.05056-14.84288 8.6528-21.66272-.83456-4.01408-4.13184-7.8848-9.80992-11.50976l-32.44032-20.70016c-4.76672-3.38944-26.85952-20.16256-17.93024-34.00192.384-.59392.85504-1.23904 1.38752-1.9456 3.63008-4.83328 10.37824-13.82912-19.3792-40.4224-12.05248-10.78272-20.97152-12.16512-27.392-12.16512-3.47136.0-6.68672.44544-9.70752.84992-3.19488.43008-6.20032.80896-9.08288.80896-12.04224.0-20.24448-6.85056-27.42784-22.91712-14.9248-33.36192-14.03392-47.64672-12.91264-65.72544.31232-5.07904.66048-10.54208.66048-16.96256.0-18.08896-.26624-24.87808-.43008-27.32032l-3.65568-4.30592 6.59456-3.42528c1.28512-.6656 31.98464-16.31744 75.79648-16.31744 14.75072.0 29.38368 1.81248 43.48416 5.376 2.59072.65536 4.60288 2.25792 5.67808 4.51072 2.19648 4.61824-.17408 9.71264-3.17952 16.16896-2.8928 6.22592-6.85056 14.7456-3.84 18.78528 3.93216 5.25824 5.73952 8.43264 6.7072 10.32704 1.46944.2304 2.62656.31232 3.75808.31232 6.90688.0 13.03552-3.06688 18.95936-6.02112 7.03488-3.51232 14.87872-6.96832 22.41024-5.28896 7.68 1.73056 11.10528 11.24352 15.44192 23.28576l2.048 5.59104c1.59744 4.28544 4.95104 5.6064 9.89184 7.12704 3.68128 1.13152 9.83552 3.03616 9.984 9.472.04608 1.81248.39424 3.85024.75264 6.0672 1.36704 8.3968 3.21536 19.89632-5.2992 31.3088-7.18336 9.64608-22.61504 11.35104-35.00544 12.71808-5.19168.57344-12.29824 1.3568-13.98784 2.57536-5.21728 3.7632-16.49664 1.24928-29.99808-2.08896-8.43264-2.08896-17.408-4.01408-22.25664-4.13696 1.2288 2.59072 4.9152 8.38656 16.1024 19.96288 1.42336.89088 8.28416.94208 12.3904.9728 9.14944.07168 18.60096.14336 24.64256 4.93568 12.5184 9.92768 20.16256 12.27776 25.7536 13.99296 14.10048 4.33664 16.39424 9.00096 22.21056 45.3888 9.08288 56.9088-4.13184 71.91552-9.76384 78.32576l-.77312.896c-14.37184 17.55648-25.04192 25.728-33.55648 25.728zM476.06784 335.85664c12.4928.0 23.7056 4.82304 35.28192 15.17568 33.37728 29.81888 29.32736 45.22496 20.96128 56.36096l-.91136 1.25952c-1.5616 2.42688 5.94432 11.55584 14.61248 17.76128l32.18432 20.52608c8.46848 5.40672 13.53728 11.83232 15.0272 19.09248 2.42688 11.71968-4.7104 22.2464-10.43456 30.70976-2.08384 3.07712-5.24288 7.7312-5.2992 9.3184.45056.75776.79872.75776.9728.75776 1.14688.0 7.71584-1.02912 24.3968-21.376l1.03936-1.21344c4.15232-4.71552 15.16544-17.22368 6.95296-68.62848-5.30944-33.26464-6.46656-33.62304-13.98784-35.93216-6.1184-1.87904-15.36512-4.72064-29.62432-16.04096-2.84672-2.25792-11.24352-2.31936-17.37728-2.36544-8.84736-.06144-16.49664-.12288-20.8128-4.5824-16.80896-17.39264-22.21056-26.87488-19.26144-33.82272 1.2032-2.8416 4.27008-6.23104 12.05248-6.23104 6.59456.0 15.81568 2.28352 24.71936 4.49024 7.52128 1.86368 15.2832 3.78368 19.50208 3.78368.91136.0 1.25952-.09728 1.27488-.09728 3.64544-2.74944 10.4448-3.49184 19.06688-4.44928 10.112-1.11616 22.69696-2.50368 26.81344-8.02304 5.50912-7.39328 4.28032-14.99136 3.08736-22.33856a91.27936 91.27936.0 01-.76288-5.54496c-.56832-.18944-1.2288-.39424-1.77152-.56832-5.1456-1.5872-13.74208-4.23936-17.50528-14.30528l-2.08384-5.71904c-2.09408-5.80096-5.25312-14.57664-7.26528-15.872-.256-.01024-.85504-.0768-1.50528-.0768-3.584.0-7.78752 2.0992-12.6464 4.5312-8.4224 4.20352-18.41664 9.12896-31.36 6.55872-3.2256-.64-5.05344-1.57184-6.7328-5.08928-.59904-1.2544-1.83808-3.86048-6.1184-9.6-7.25504-9.70752-1.5616-21.93408 2.59072-30.85824.7168-1.55136 1.59744-3.44064 2.19648-4.96128a166.0928 166.0928.0 00-37.44768-4.2496c-32.5888.0-57.82016 9.472-66.79552 13.3632.24064 4.57728.33792 12.36992.33792 26.15808.0 6.69696-.34816 12.40064-.68096 17.70496-1.06496 17.09056-1.83808 29.44512 11.89376 60.14976 7.12704 15.90784 12.84096 15.90784 16.62464 15.90784 2.3808.0 4.86912-.35328 7.50592-.70656 3.52768-.47104 7.26528-.95744 11.2896-.95744z" fill="#6b0204" p-id="46162"/><path d="M236.64128 731.76576s16.7424-46.29504 40.38656-47.27808 26.59328 13.78816 26.59328 21.66784 5.90848 22.656 13.78816 26.59328c7.87968 3.9424 69.93408 11.82208 88.64768 15.75936s41.3696 10.83392 46.29504 23.63904c4.92544 12.80512-2.95424 29.54752-6.89664 39.3984-3.9424 9.85088-7.87968 9.85088 2.95424 22.656s25.61024 12.80512 33.48992 22.656 10.83392 19.70176 10.83392 19.70176l2.95424 7.87968s-103.424-5.90848-171.38688-53.19168-87.65952-99.4816-87.65952-99.4816z" fill="#ffec43" p-id="46163"/><path d="M504.4224 890.86976l-9.06752-.52224c-4.29056-.24064-105.88672-6.5536-174.42816-54.23616-68.69504-47.78496-88.99584-100.05504-89.8304-102.25152l-.77312-2.05312.75264-2.05312c1.85344-5.12512 18.8672-50.06848 45.70624-51.18464l2.45248-.0512c18.98496.0 30.3104 10.33216 30.3104 27.63776.0 6.6304 5.43744 18.75968 10.51648 21.2992 4.13184 2.03264 32.76288 6.4512 51.712 9.3696 14.48448 2.23232 28.17024 4.34176 35.51744 5.89312 29.75232 6.26176 45.83424 14.94016 50.60096 27.30496 5.33504 13.85472-1.36704 30.16704-5.79584 40.96512l-1.13152 2.7648c-.79872 2.00192-1.59744 3.63008-2.28864 5.04832-1.95584 3.968-2.03776 4.1216 4.27008 11.58144 4.87936 5.77024 10.7008 8.48896 16.86528 11.37152 5.96992 2.79552 12.14464 5.67808 16.72704 11.40736 8.50432 10.61888 11.75552 21.25312 11.8784 21.69856l6.00576 16.01024zM243.0208 731.64288c4.37248 9.81504 26.53696 54.30784 84.6592 94.74048 54.18496 37.69344 132.67968 48.63488 159.2064 51.34848a61.184 61.184.0 00-9.61536-17.16736c-2.84672-3.56864-7.3216-5.6576-12.4928-8.07936-6.7072-3.13344-14.32064-6.69696-20.89472-14.44864-9.7536-11.53536-10.01984-16.01024-5.85216-24.46848.57856-1.18784 1.25952-2.54464 1.93024-4.224l1.15712-2.85696c3.72736-9.05728 9.34912-22.75328 5.70368-32.2048-2.12992-5.5296-11.14112-13.48096-41.984-19.97312-7.03488-1.47968-20.5568-3.56864-34.87744-5.78048-30.81728-4.75648-49.90464-7.8336-55.20384-10.48064-10.41408-5.21216-17.06496-22.36928-17.06496-31.89248.0-10.624-6.03648-15.79008-18.46272-15.79008l-1.96608.04096c-15.10912.62976-29.30176 28.74368-34.24256 41.23648z" fill="#6b0204" p-id="46164"/></svg>
<span>主页 | Home</span></a></li><li><a href=/about/><!doctype html><svg t="1731207041004" class="icon" viewBox="0 0 1024 1024" p-id="28166" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M234.667 530.464a277.333 277.333.0 10554.666.0 277.333 277.333.0 10-554.666.0z" fill="#ffdc00" p-id="28167"/><path d="M459.1 424.3c-39.3 96-61.8 177.9-67 243.2-4.6 58.5 4.5 105.3 27.1 139 25.1 37.4 66.8 58 117.4 58 72.7.0 143.7-20.1 205.4-58.1l2.1-1.1 1.5-.9c55.1-35.2 101-84.1 133-141.3 32.9-59 50.3-126.2 50.3-194.3.0-56.8-11-111.9-32.8-163.9-21-50.1-51.2-95.2-89.5-133.8-38.4-38.7-83.1-69.1-132.9-90.3-51.6-22-106.3-33.1-162.8-33.1-59.8.0-117.9 11.8-172.6 35.1-52.8 22.5-100.2 54.7-140.9 95.7s-72.6 88.7-94.9 141.9c-23.1 55-34.8 113.5-34.8 173.7.0 63.9 12.4 125.9 36.9 184.2 23.7 56.4 57.5 107 100.7 150.5 43.1 43.5 93.4 77.6 149.4 101.5 58 24.7 119.5 37.2 183 37.2 95.7.0 188.7-27.4 268.9-79.3 11.1-7.2 14.3-22.1 7.1-33.2-7.2-11.1-22.1-14.3-33.2-7.1-72.4 46.8-156.4 71.6-242.8 71.6-56.9.0-112.2-11.2-164.2-33.4-50.2-21.4-95.4-52.1-134.1-91.1-38.8-39.1-69.2-84.6-90.5-135.2-22-52.4-33.2-108.2-33.2-165.6.0-53.8 10.5-106 31.1-155.1 19.9-47.4 48.4-90.1 84.7-126.7s78.6-65.3 125.6-85.4c48.7-20.8 100.4-31.3 153.7-31.3 98.8.0 191.7 38.8 261.6 109.2 69.9 70.5 108.4 164.2 108.4 263.9.0 59.9-15.3 119.1-44.3 171-27.9 50.1-68.1 92.9-116.2 123.8l-1.9 1c-.4.2-.8.5-1.2.7-54.3 33.5-116.8 51.3-180.7 51.3-24.1.0-57.2-6.4-77.6-36.7-16.4-24.5-22.9-60.9-19.1-108.4 4.8-60.4 26.2-137.4 63.6-228.9 5-12.3-.9-26.3-13.1-31.3-12.2-5.1-26.2.8-31.2 13z" fill="#6b400d" p-id="28168"/><path d="M509.3 384.7c16.6.0 30-13.4 30-30s-13.4-30-30-30-30 13.4-30 30 13.4 30 30 30z" fill="#6b400d" p-id="28169"/></svg>
<span>关于我 | about</span></a></li><li><a href=/archives/><!doctype html><svg t="1731206951201" class="icon" viewBox="0 0 1024 1024" p-id="24351" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M132.564341 21.829457h381.817054V998.20155H132.564341z" fill="#e8655a" p-id="24352"/><path d="M234.170543 122.64186H412.775194v458.021706H234.170543z" fill="#e6e6e6" p-id="24353"/><path d="M323.075969 809.277519m-61.916279.0a61.916279 61.916279.0 10123.832558.0 61.916279 61.916279.0 10-123.832558.0z" fill="#b3b3b3" p-id="24354"/><path d="M514.381395 21.829457h381.023256v975.578295H514.381395z" fill="#ffba57" p-id="24355"/><path d="M615.193798 122.64186H793.79845v458.021706H615.193798z" fill="#e6e6e6" p-id="24356"/><path d="M704.893023 809.277519m-61.916279.0a61.916279 61.916279.0 10123.832558.0 61.916279 61.916279.0 10-123.832558.0z" fill="#b3b3b3" p-id="24357"/><path d="M412.775194 102.003101H234.170543c-11.113178.0-19.844961 8.731783-19.844962 19.844961v458.021705c0 11.113178 8.731783 19.844961 19.844962 19.844962H412.775194c11.113178.0 19.844961-8.731783 19.844961-19.844962V122.64186c0-11.113178-8.731783-20.63876-19.844961-20.638759zm-20.63876 458.021705H254.015504V142.486822h138.12093v417.537984zM323.075969 726.722481c-45.246512.0-82.555039 37.308527-82.555039 82.555038s37.308527 82.555039 82.555039 82.555039 82.555039-37.308527 82.555039-82.555039-36.514729-82.555039-82.555039-82.555038zm0 124.626356c-23.020155.0-42.071318-19.051163-42.071318-42.071318s19.051163-42.071318 42.071318-42.071317 42.071318 19.051163 42.071318 42.071317-19.051163 42.071318-42.071318 42.071318z" fill="#603813" p-id="24358"/><path d="M895.404651 1018.046512c11.113178.0 19.844961-8.731783 19.844961-19.844962V21.829457c0-11.113178-8.731783-19.844961-19.844961-19.844961H132.564341c-11.113178.0-19.844961 8.731783-19.844961 19.844961v975.578295c0 11.113178 8.731783 19.844961 19.844961 19.844961h762.84031v.793799zM153.203101 42.468217h340.539535v935.094574H153.203101V42.468217zm721.56279 935.094574H534.226357V42.468217h340.539534v935.094574z" fill="#603813" p-id="24359"/><path d="M615.193798 600.508527H793.79845c11.113178.0 19.844961-8.731783 19.844961-19.844961V122.64186c0-11.113178-8.731783-19.844961-19.844961-19.844961H615.193798c-11.113178.0-19.844961 8.731783-19.844961 19.844961v458.021706c0 11.113178 8.731783 19.844961 19.844961 19.844961zm20.63876-458.021705h138.12093v417.537984H635.832558V142.486822zM704.893023 726.722481c-45.246512.0-82.555039 37.308527-82.555039 82.555038s37.308527 82.555039 82.555039 82.555039 82.555039-37.308527 82.555039-82.555039-37.308527-82.555039-82.555039-82.555038zm0 124.626356c-23.020155.0-42.071318-19.051163-42.071318-42.071318s19.051163-42.071318 42.071318-42.071317 42.071318 19.051163 42.071318 42.071317-19.051163 42.071318-42.071318 42.071318zM303.231008 223.454264h40.483721c11.113178.0 19.844961-8.731783 19.844961-19.844962s-8.731783-19.844961-19.844961-19.844961h-40.483721c-11.113178.0-19.844961 8.731783-19.844961 19.844961-.793798 10.31938 8.731783 19.844961 19.844961 19.844962zm0 81.76124h40.483721c11.113178.0 19.844961-8.731783 19.844961-19.844961s-8.731783-19.844961-19.844961-19.844962h-40.483721c-11.113178.0-19.844961 8.731783-19.844961 19.844962s8.731783 19.844961 19.844961 19.844961z" fill="#603813" p-id="24360"/><path d="M735.057364 319.503876c-11.113178.0-19.844961 8.731783-19.844961 19.844961V517.953488c0 11.113178 8.731783 19.844961 19.844961 19.844962s19.844961-8.731783 19.844962-19.844962V339.348837c0-11.113178-8.731783-19.844961-19.844962-19.844961zm0-88.905426c-11.113178.0-19.844961 8.731783-19.844961 19.844961v22.226356c0 11.113178 8.731783 19.844961 19.844961 19.844962s19.844961-8.731783 19.844962-19.844962v-22.226356c0-10.31938-8.731783-19.844961-19.844962-19.844961z" fill="#603813" p-id="24361"/></svg>
<span>归档 | archives</span></a></li><li><a href=/search/><!doctype html><svg t="1731206913422" class="icon" viewBox="0 0 1024 1024" p-id="22047" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M596.48 728.64a8.032 8.032.0 01-5.664-2.336l-92.208-92.208a8.048 8.048.0 01.784-12.016 233.04 233.04.0 0043.744-43.744 8.032 8.032.0 0112.016-.784l92.208 92.208a8 8 0 010 11.312l-45.248 45.248a7.952 7.952.0 01-5.632 2.32zm-80.192-99.52 80.208 80.208 33.936-33.936-80.208-80.208a248.256 248.256.0 01-33.936 33.936zM688 152.016h-64a8 8 0 010-16h64a8 8 0 010 16z" fill="#263238" p-id="22048"/><path d="M656 184.016a8 8 0 01-8-8v-64a8 8 0 0116 0v64a8 8 0 01-8 8zm128 48h-64a8 8 0 010-16h64a8 8 0 010 16z" fill="#263238" p-id="22049"/><path d="M752 264.016a8 8 0 01-8-8v-64a8 8 0 0116 0v64a8 8 0 01-8 8z" fill="#263238" p-id="22050"/><path d="M647.392 669.728l-56.576 56.576a15.984 15.984.0 000 22.624L749.2 907.312a15.984 15.984.0 0022.624.0l56.576-56.576a15.984 15.984.0 000-22.624L670.016 669.728a16 16 0 00-22.624.0z" fill="#40c4ff" p-id="22051"/><path d="M760.528 919.984c-6.144.0-12.288-2.336-16.976-7.008l-158.384-158.4a23.76 23.76.0 01-7.024-16.96c0-6.4 2.496-12.448 7.024-16.992l56.56-56.56a24 24 0 0133.952.0l158.384 158.384a24.016 24.016.0 010 33.936l-56.576 56.576a23.792 23.792.0 01-16.96 7.024zM658.704 673.04a8.016 8.016.0 00-5.664 2.336l-56.56 56.56a7.952 7.952.0 000 11.312l158.384 158.4a8.064 8.064.0 0011.312.0l56.576-56.576a8 8 0 000-11.328L664.368 675.36a8 8 0 00-5.664-2.32zM358.896 685.792c-136.752.0-248-111.248-248-248s111.248-248 248-248c136.736.0 248 111.248 248 248s-111.248 248-248 248zm0-480c-127.92.0-232 104.08-232 232s104.08 232 232 232 232-104.08 232-232-104.08-232-232-232z" fill="#263238" p-id="22052"/><path d="M550.896 437.808c0 106.032-85.968 192-192 192s-192-85.968-192-192 85.968-192 192-192c106.048.0 192 85.952 192 192z" fill="#ffd740" p-id="22053"/><path d="M358.896 637.792c-110.288.0-2e2-89.712-2e2-2e2s89.712-2e2 2e2-2e2c110.272.0 2e2 89.712 2e2 2e2s-89.728 2e2-2e2 2e2zm0-384c-101.456.0-184 82.544-184 184s82.544 184 184 184 184-82.544 184-184-82.544-184-184-184z" fill="#263238" p-id="22054"/><path d="M502.896 445.792a8 8 0 01-8-8c0-74.992-61.008-136-136-136a8 8 0 010-16c83.808.0 152 68.192 152 152 0 4.432-3.568 8-8 8zM144 780.912H112a8 8 0 010-16h32a8 8 0 010 16zm208 0H176a8 8 0 010-16h176a8 8 0 010 16z" fill="#263238" p-id="22055"/><path d="M912 540.912h-32a8 8 0 010-16h32a8 8 0 010 16z" fill="#263238" p-id="22056"/><path d="M848 540.912H672a8 8 0 010-16h176a8 8 0 010 16z" fill="#263238" p-id="22057"/></svg>
<span>搜索 | search</span></a></li><li><a href=/links/><!doctype html><svg t="1731207139348" class="icon" viewBox="0 0 1059 1024" p-id="33253" xmlns:xlink="http://www.w3.org/1999/xlink" width="206.8359375" height="200"><path d="M680.677517 503.172414c0-20.585931-17.160828-37.782069-37.782069-37.782069H416.414897c-20.621241.0-37.782069 17.196138-37.782069 37.782069s17.160828 37.782069 37.782069 37.782069h226.480551c20.621241.0 37.782069-17.196138 37.782069-37.782069z" fill="#77e26c" p-id="33254"/><path d="M636.186483 396.641103h142.194758a106.53131 106.53131.0 110 213.062621H636.186483v70.867862h142.194758a177.893517 177.893517.0 00177.434483-177.399172A177.893517 177.893517.0 00778.381241 325.773241H636.186483v70.867862zM423.123862 609.703724H280.929103a106.53131 106.53131.0 110-213.062621h142.194759V325.773241H280.929103A177.893517 177.893517.0 00103.45931 503.172414a177.893517 177.893517.0 00177.434483 177.399172h142.194759v-70.867862z" fill="#52bc47" p-id="33255"/></svg>
<span>友链 | links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><ol><li><a href=#basic-authentication><strong>Basic Authentication</strong></a></li><li><a href=#token认证><strong>TOKEN认证</strong></a></li><li><a href=#oauth20><strong>OAuth2.0</strong></a></li></ol></li></ol></li><li><a href=#什么是jwt>什么是JWT</a><ol><li><a href=#jwt的构成>JWT的构成</a></li></ol></li><li><a href=#如何应用>如何应用</a></li><li><a href=#安全相关>安全相关</a></li></ol><ol><li><ol><li><a href=#添加maven依赖>添加Maven依赖</a></li><li><a href=#创建用户service>创建用户Service</a></li><li><a href=#用户信息类>用户信息类：</a></li><li><a href=#jwt工具类>JWT工具类</a></li><li><a href=#编写登录接口>编写登录接口</a></li><li><a href=#编写restful接口>编写RESTful接口</a></li><li><a href=#自定义异常>自定义异常</a></li><li><a href=#处理框架异常>处理框架异常</a></li><li><a href=#配置shiro>配置Shiro</a></li></ol></li><li><a href=#运行验证>运行验证</a></li><li><a href=#参考文章>参考文章</a></li><li><a href=#github源码>GitHub源码</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/springboot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90jwt%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/><img src=https://image.tianhui.xin/liveLearn/5/api-security.jpg loading=lazy alt="Featured image of post springBoot系列 - 集成JWT实现接口权限认证"></a></div><div class=article-details><header class=article-category><a href=/categories/%E5%AD%A6%E6%97%A0%E6%AD%A2%E5%A2%83/ style=background-color:#2a9d8f;color:#fff>学无止境</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/springboot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90jwt%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/>springBoot系列 - 集成JWT实现接口权限认证</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 20, 2018</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 10 分钟</time></div></footer></div></header><section class=article-content><p>springBoot系列 - 集成JWT实现接口权限认证</p><p>一般来讲，对于RESTful API都会有认证(Authentication)和授权(Authorization)过程，保证API的安全性。</p><p><strong>Authentication vs. Authorization</strong></p><p>Authentication指的是确定这个用户的身份，Authorization是确定该用户拥有什么操作权限。</p><p><strong>认证方式一般有三种</strong></p><h4 id=basic-authentication><strong>Basic Authentication</strong></h4><p>这种方式是直接将用户名和密码放到Header中，使用Authorization: Basic Zm9vOmJhcg==，使用最简单但是最不安全。</p><h4 id=token认证><strong>TOKEN认证</strong></h4><p>这种方式也是再HTTP头中，使用Authorization: Bearer <token>，使用最广泛的TOKEN是JWT，通过签名过的TOKEN。</p><h4 id=oauth20><strong>OAuth2.0</strong></h4><p>这种方式安全等级最高，但是也是最复杂的。如果不是大型API平台或者需要给第三方APP使用的，没必要整这么复杂。
一般项目中的RESTful API使用JWT来做认证就足够了。</p><h2 id=什么是jwt>什么是JWT</h2><p>Json web token (JWT), 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（(RFC 7519).该token被设计为紧凑且安全的， 特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息， 以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</p><p>JWT官网：<a class=link href=https://jwt.io/ target=_blank rel=noopener>https://jwt.io/</a></p><p>JWT是由三段信息构成的，将这三段信息文本用.链接一起就构成了Jwt字符串。就像这样:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span class=p>.</span><span class=na>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9</span><span class=p>.</span><span class=na>TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=jwt的构成>JWT的构成</h3><p>第一部分我们称它为头部（header),第二部分我们称其为载荷（payload, 类似于飞机上承载的物品)，第三部分是签证（signature)。</p><p><strong>header</strong></p><p>jwt的头部承载两部分信息：</p><ul><li>声明类型，这里是jwt</li><li>声明加密的算法 通常直接使用 HMAC SHA256</li></ul><p>这里的加密算法是单向函数散列算法，常见的有MD5、SHA、HAMC。这里使用基于密钥的Hash算法HMAC生成散列值。</p><ul><li>MD5 message-digest algorithm 5 （信息-摘要算法）缩写，广泛用于加密和解密技术，常用于文件校验。校验？不管文件多大，经过MD5后都能生成唯一的MD5值</li><li>SHA (Secure Hash Algorithm，安全散列算法），数字签名等密码学应用中重要的工具，安全性高于MD5</li><li>HMAC (Hash Message Authentication Code，散列消息鉴别码，基于密钥的Hash算法的认证协议。用公开函数和密钥产生一个固定长度的值作为认证标识，用这个标识鉴别消息的完整性。</li></ul><p>常用于接口签名验证完整的头部就像下面这样的JSON：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=err>&#39;typ&#39;:</span> <span class=err>&#39;JWT&#39;,</span>
</span></span><span class=line><span class=cl><span class=err>&#39;alg&#39;:</span> <span class=err>&#39;HS256&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后将头部进行base64加密（该加密是可以对称解密的),构成了第一部分</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>playload</strong></p><p>载荷就是存放有效信息的地方，这些有效信息包含三个部分：</p><ul><li>标准中注册的声明</li><li>公共的声明</li><li>私有的声明</li></ul><p>标准中注册的声明 (建议但不强制使用) ：</p><ul><li>iss: jwt签发者</li><li>sub: jwt所面向的用户</li><li>aud: 接收jwt的一方</li><li>exp: jwt的过期时间，这个过期时间必须要大于签发时间</li><li>nbf: 定义在什么时间之前，该jwt都是不可用的.</li><li>iat: jwt的签发时间</li><li>jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</li></ul><p>公共的声明：</p><p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密</p><p>私有的声明：</p><p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p><p>定义一个payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;sub&#34;</span><span class=p>:</span> <span class=s2>&#34;1234567890&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;John Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;admin&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后将其进行base64加密，得到Jwt的第二部分：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>signature</strong></p><p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p><ul><li>header (base64后的)</li><li>payload (base64后的)</li><li>secret</li></ul><p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串， 然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// javascript
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>encodedString</span> <span class=o>=</span> <span class=nx>base64UrlEncode</span><span class=p>(</span><span class=nx>header</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;.&#39;</span> <span class=o>+</span> <span class=nx>base64UrlEncode</span><span class=p>(</span><span class=nx>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>signature</span> <span class=o>=</span> <span class=nx>HMACSHA256</span><span class=p>(</span><span class=nx>encodedString</span><span class=p>,</span> <span class=s1>&#39;secret&#39;</span><span class=p>);</span> <span class=c1>// TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</span></span></span></code></pre></td></tr></table></div></div><p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p><p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</p><p>==注意==：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证， 所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p><h2 id=如何应用>如何应用</h2><p>一般是在请求头里加入Authorization，并加上Bearer标注：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;api/user/1&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Authorization&#39;</span><span class=o>:</span> <span class=s1>&#39;Bearer &#39;</span> <span class=o>+</span> <span class=nx>token</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器负责解析这个HTTP头来做用户认证和授权处理。大致流程如下：</p><p><img src=http://image.tianhui.xin/liveLearn/5/jwt20.png loading=lazy alt=流程></p><h2 id=安全相关>安全相关</h2><p>JWT协议本身不具备安全传输功能，所以必须借助于SSL/TLS的安全通道，所以建议如下：</p><ol><li>不应该在jwt的payload部分存放敏感信息，因为该部分是客户端可解密的部分。</li><li>保护好secret私钥，该私钥非常重要。</li><li>如果可以，请使用https协议</li></ol><h1 id=和springboot集成>和SpringBoot集成</h1><p>简要的说明下我们为什么要用JWT，因为我们要实现完全的前后端分离，所以不可能使用session，cookie的方式进行鉴权， 所以JWT就被派上了用场，可以通过一个加密密钥来进行前后端的鉴权。</p><p><strong>程序逻辑</strong></p><ol><li>我们POST用户名与密码到/login进行登入，如果成功返回一个加密token，失败的话直接返回401错误。</li><li>之后用户访问每一个需要权限的网址请求必须在header中添加Authorization字段，例如Authorization: token，token为密钥。</li><li>后台会进行token的校验，如果不通过直接返回401。</li></ol><p><strong>这里我讲一下如何在SpringBoot中使用JWT来做接口权限认证，安全框架依旧使用Shiro，JWT的实现使用 jjwt</strong></p><h3 id=添加maven依赖>添加Maven依赖</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;exclusions&gt;</span> 
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;exclusion&gt;</span> 
</span></span><span class=line><span class=cl>		<span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class=nt>&lt;/artifactId&gt;</span> 
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;/exclusion&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/exclusions&gt;</span> 
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-jetty<span class=nt>&lt;/artifactId&gt;</span> 
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>com.auth0<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>java-jwt<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;version&gt;</span>3.3.0<span class=nt>&lt;/version&gt;</span> 
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>  
</span></span><span class=line><span class=cl><span class=c>&lt;!-- shiro 权限控制 --&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>org.apache.shiro<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>shiro-spring<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;version&gt;</span>1.4.0<span class=nt>&lt;/version&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;exclusions&gt;</span> 
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;exclusion&gt;</span> 
</span></span><span class=line><span class=cl>		<span class=nt>&lt;artifactId&gt;</span>slf4j-api<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span> 
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;/exclusion&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/exclusions&gt;</span> 
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>  
</span></span><span class=line><span class=cl><span class=c>&lt;!-- shiro ehcache (shiro缓存)--&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>org.apache.shiro<span class=nt>&lt;/groupId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>shiro-ehcache<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;version&gt;</span>1.4.0<span class=nt>&lt;/version&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;exclusions&gt;</span> 
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;exclusion&gt;</span> 
</span></span><span class=line><span class=cl>		<span class=nt>&lt;artifactId&gt;</span>slf4j-api<span class=nt>&lt;/artifactId&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span> 
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;/exclusion&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/exclusions&gt;</span> 
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span> 
</span></span></code></pre></td></tr></table></div></div><h3 id=创建用户service>创建用户Service</h3><p>这个在shiro一节讲过如果创建角色权限表，添加用户Service来执行查找用户操作，这里就不多讲具体实现了，只列出关键代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>* 通过名称查找用户
</span></span></span><span class=line><span class=cl><span class=cm>*
</span></span></span><span class=line><span class=cl><span class=cm>* @param username
</span></span></span><span class=line><span class=cl><span class=cm>* @return
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ManagerInfo</span><span class=w> </span><span class=nf>findByUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ManagerInfo</span><span class=w> </span><span class=n>managerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>managerInfoDao</span><span class=p>.</span><span class=na>findByUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>managerInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnknownAccountException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>managerInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=用户信息类>用户信息类：</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ManagerInfo</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 主键ID
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 账号
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 密码
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * md5密码盐
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>salt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 一个管理员具有多个角色
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SysRole</span><span class=o>&gt;</span><span class=w> </span><span class=n>roles</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=jwt工具类>JWT工具类</h3><p>我们写一个简单的JWT加密，校验工具，并且使用用户自己的密码充当加密密钥， 这样保证了token 即使被他人截获也无法破解。并且我们在token中附带了username信息，并且设置密钥5分钟就会过期。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JWTUtil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 过期时间5分钟</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>EXPIRE_TIME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 校验token是否正确
</span></span></span><span class=line><span class=cl><span class=cm>    *
</span></span></span><span class=line><span class=cl><span class=cm>    * @param token 密钥
</span></span></span><span class=line><span class=cl><span class=cm>    * @param secret 用户的密码
</span></span></span><span class=line><span class=cl><span class=cm>    * @return 是否正确
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>verify</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>secret</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Algorithm</span><span class=w> </span><span class=n>algorithm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Algorithm</span><span class=p>.</span><span class=na>HMAC256</span><span class=p>(</span><span class=n>secret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>JWTVerifier</span><span class=w> </span><span class=n>verifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JWT</span><span class=p>.</span><span class=na>require</span><span class=p>(</span><span class=n>algorithm</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                      </span><span class=p>.</span><span class=na>withClaim</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DecodedJWT</span><span class=w> </span><span class=n>jwt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>verifier</span><span class=p>.</span><span class=na>verify</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>exception</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 获得token中的信息无需secret解密也能获得
</span></span></span><span class=line><span class=cl><span class=cm>    *
</span></span></span><span class=line><span class=cl><span class=cm>    * @return token中包含的用户名
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DecodedJWT</span><span class=w> </span><span class=n>jwt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JWT</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>jwt</span><span class=p>.</span><span class=na>getClaim</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>).</span><span class=na>asString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>JWTDecodeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 生成签名,5min后过期
</span></span></span><span class=line><span class=cl><span class=cm>    *
</span></span></span><span class=line><span class=cl><span class=cm>    * @param username 用户名
</span></span></span><span class=line><span class=cl><span class=cm>    * @param secret 用户的密码
</span></span></span><span class=line><span class=cl><span class=cm>    * @return 加密的token
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>sign</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>secret</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Date</span><span class=w> </span><span class=n>date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>EXPIRE_TIME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Algorithm</span><span class=w> </span><span class=n>algorithm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Algorithm</span><span class=p>.</span><span class=na>HMAC256</span><span class=p>(</span><span class=n>secret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 附带username信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>JWT</span><span class=p>.</span><span class=na>create</span><span class=p>().</span><span class=na>withClaim</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=p>.</span><span class=na>withExpiresAt</span><span class=p>(</span><span class=n>date</span><span class=p>).</span><span class=na>sign</span><span class=p>(</span><span class=n>algorithm</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>UnsupportedEncodingException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=编写登录接口>编写登录接口</h3><p>为了让用户登录的时候获取到正确的JWT Token，需要实现登录接口，这里我编写一个LoginController.java：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LoginController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>_logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>LoginController</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ManagerInfoService</span><span class=w> </span><span class=n>managerInfoService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BaseResponse</span><span class=w> </span><span class=nf>login</span><span class=p>(</span><span class=nd>@RequestParam</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=nd>@RequestParam</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ManagerInfo</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>managerInfoService</span><span class=p>.</span><span class=na>findByUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//盐（用户名+随机数）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>salt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getSalt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//原密码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>encodedPassword</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ShiroKit</span><span class=p>.</span><span class=na>md5</span><span class=p>(</span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>salt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=na>getPassword</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>encodedPassword</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BaseResponse</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Login success&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>JWTUtil</span><span class=p>.</span><span class=na>sign</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>encodedPassword</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnauthorizedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/401&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ResponseStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BaseResponse</span><span class=w> </span><span class=nf>unauthorized</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BaseResponse</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unauthorized&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>注意上面登录的时候，我会从数据库中把这个用户取出来，密码加盐算MD5值比较，通过之后再用密码作为密钥来签名生成JWT。</p><h3 id=编写restful接口>编写RESTful接口</h3><p>先编写一个通用的接口返回类：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>* API接口的基础返回类
</span></span></span><span class=line><span class=cl><span class=cm>*
</span></span></span><span class=line><span class=cl><span class=cm>* @author XiongNeng
</span></span></span><span class=line><span class=cl><span class=cm>* @version 1.0
</span></span></span><span class=line><span class=cl><span class=cm>* @since 2018/1/7
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BaseResponse</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 是否成功
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 说明
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 返回数据
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>BaseResponse</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>BaseResponse</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>success</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通过SpringMVC实现RESTful接口，这里我只写一个示例方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/api/v1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PublicController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ApiService</span><span class=w> </span><span class=n>apiService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 请求入网接口
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 处理结果
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/join&#34;</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RequestMethod</span><span class=p>.</span><span class=na>POST</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@RequiresRoles</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>BaseResponse</span><span class=o>&gt;</span><span class=w> </span><span class=nf>doJoin</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>PosParam</span><span class=w> </span><span class=n>posParam</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_logger</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;请求入网接口 start....&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BaseResponse</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BaseResponse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// imei码约束检查</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>posParam</span><span class=p>.</span><span class=na>getImei</span><span class=p>())</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>posParam</span><span class=p>.</span><span class=na>getImei</span><span class=p>().</span><span class=na>length</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>32</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=na>setSuccess</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=na>setMsg</span><span class=p>(</span><span class=s>&#34;IMEI码长度不是1-32位，入网失败。&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>OK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Pos</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Pos</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Date</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pos</span><span class=p>.</span><span class=na>setJointime</span><span class=p>(</span><span class=n>now</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pos</span><span class=p>.</span><span class=na>setBindtime</span><span class=p>(</span><span class=n>now</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>posParam</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 插入一条新纪录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pos</span><span class=p>.</span><span class=na>setProjectId</span><span class=p>(</span><span class=n>project</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>insert</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>apiService</span><span class=p>.</span><span class=na>insertPos</span><span class=p>(</span><span class=n>pos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>insert</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=na>setSuccess</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=na>setMsg</span><span class=p>(</span><span class=s>&#34;入网成功&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>CREATED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=na>setSuccess</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=na>setMsg</span><span class=p>(</span><span class=s>&#34;入网失败，请联系管理员。&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>OK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=自定义异常>自定义异常</h3><p>为了实现我自己能够手动抛出异常，我自己写了一个<code>UnauthorizedException.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnauthorizedException</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RuntimeException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UnauthorizedException</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>UnauthorizedException</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=处理框架异常>处理框架异常</h3><p>之前说过restful要统一返回的格式，所以我们也要全局处理Spring Boot的抛出异常。利用@RestControllerAdvice能很好的实现。 注意这个统一异常处理器只对认证过的用户调用接口中的异常有作用，对AuthenticationException没有用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestControllerAdvice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExceptionController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 捕捉shiro的异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ResponseStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>(</span><span class=n>ShiroException</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BaseResponse</span><span class=w> </span><span class=nf>handle401</span><span class=p>(</span><span class=n>ShiroException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BaseResponse</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=s>&#34;shiro的异常&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 捕捉UnauthorizedException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ResponseStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>(</span><span class=n>UnauthorizedException</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BaseResponse</span><span class=w> </span><span class=nf>handle401</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BaseResponse</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=s>&#34;UnauthorizedException&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 捕捉其他所有异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>(</span><span class=n>Exception</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ResponseStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>BAD_REQUEST</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>BaseResponse</span><span class=w> </span><span class=nf>globalException</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BaseResponse</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=s>&#34;其他异常&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>HttpStatus</span><span class=w> </span><span class=nf>getStatus</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>statusCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getAttribute</span><span class=p>(</span><span class=s>&#34;javax.servlet.error.status_code&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>statusCode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>statusCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=配置shiro>配置Shiro</h3><p>大家可以先看下官方的<a class=link href=http://shiro.apache.org/spring.html target=_blank rel=noopener>Spring-Shiro</a>整合教程，有个初步的了解。 不过既然我们用了SpringBoot，那我们肯定要争取零配置文件。</p><p><strong>实现JWTToken</strong></p><p>JWTToken差不多就是Shiro用户名密码的载体。因为我们是前后端分离，服务器无需保存用户状态，所以不需要RememberMe这类功能， 我们简单的实现下AuthenticationToken接口即可。因为token自己已经包含了用户名等信息，所以这里我就弄了一个字段。 如果你喜欢钻研，可以看看官方的UsernamePasswordToken是如何实现的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JWTToken</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AuthenticationToken</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 密钥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>JWTToken</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getPrincipal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getCredentials</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>实现Realm</strong></p><p>realm的用于处理用户是否合法的这一块，需要我们自己实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Description  : 身份校验核心类
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyShiroRealm</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AuthorizingRealm</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>_logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>MyShiroRealm</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ManagerInfoService</span><span class=w> </span><span class=n>managerInfoService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * JWT签名密钥，这里没用。我使用的是用户的MD5密码作为签名密钥
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>SECRET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;9281e268b77b7c439a20b46fd1483b9a&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 必须重写此方法，不然Shiro会报错
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>supports</span><span class=p>(</span><span class=n>AuthenticationToken</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>JWTToken</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 认证信息(身份验证)
</span></span></span><span class=line><span class=cl><span class=cm>     * Authentication 是用来验证用户身份
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param auth
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws AuthenticationException
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>AuthenticationInfo</span><span class=w> </span><span class=nf>doGetAuthenticationInfo</span><span class=p>(</span><span class=n>AuthenticationToken</span><span class=w> </span><span class=n>auth</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>AuthenticationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_logger</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;MyShiroRealm.doGetAuthenticationInfo()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>auth</span><span class=p>.</span><span class=na>getCredentials</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 解密获得username，用于和数据库进行对比</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JWTUtil</span><span class=p>.</span><span class=na>getUsername</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>username</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AuthenticationException</span><span class=p>(</span><span class=s>&#34;token invalid&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//通过username从数据库中查找 ManagerInfo对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ManagerInfo</span><span class=w> </span><span class=n>managerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>managerInfoService</span><span class=p>.</span><span class=na>findByUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>managerInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AuthenticationException</span><span class=p>(</span><span class=s>&#34;User didn&#39;t existed!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>JWTUtil</span><span class=p>.</span><span class=na>verify</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>managerInfo</span><span class=p>.</span><span class=na>getPassword</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AuthenticationException</span><span class=p>(</span><span class=s>&#34;Username or password error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleAuthenticationInfo</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=s>&#34;my_realm&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 此方法调用hasRole,hasPermission的时候才会进行回调.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 权限信息.(授权):
</span></span></span><span class=line><span class=cl><span class=cm>     * 1、如果用户正常退出，缓存自动清空；
</span></span></span><span class=line><span class=cl><span class=cm>     * 2、如果用户非正常退出，缓存自动清空；
</span></span></span><span class=line><span class=cl><span class=cm>     * 3、如果我们修改了用户的权限，而用户不退出系统，修改的权限无法立即生效。
</span></span></span><span class=line><span class=cl><span class=cm>     * （需要手动编程进行实现；放在service进行调用）
</span></span></span><span class=line><span class=cl><span class=cm>     * 在权限修改后调用realm中的方法，realm已经由spring管理，所以从spring中获取realm实例，调用clearCached方法；
</span></span></span><span class=line><span class=cl><span class=cm>     * :Authorization 是授权访问控制，用于对用户进行的操作授权，证明该用户是否允许进行当前操作，如访问某个链接，某个资源文件等。
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param principals
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>AuthorizationInfo</span><span class=w> </span><span class=nf>doGetAuthorizationInfo</span><span class=p>(</span><span class=n>PrincipalCollection</span><span class=w> </span><span class=n>principals</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * 当没有使用缓存的时候，不断刷新页面的话，这个代码会不断执行，
</span></span></span><span class=line><span class=cl><span class=cm>         * 当其实没有必要每次都重新设置权限信息，所以我们需要放到缓存中进行管理；
</span></span></span><span class=line><span class=cl><span class=cm>         * 当放到缓存中时，这样的话，doGetAuthorizationInfo就只会执行一次了，
</span></span></span><span class=line><span class=cl><span class=cm>         * 缓存过期之后会再次执行。
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_logger</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;权限配置--&gt;MyShiroRealm.doGetAuthorizationInfo()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JWTUtil</span><span class=p>.</span><span class=na>getUsername</span><span class=p>(</span><span class=n>principals</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 下面的可以使用缓存提升速度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ManagerInfo</span><span class=w> </span><span class=n>managerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>managerInfoService</span><span class=p>.</span><span class=na>findByUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleAuthorizationInfo</span><span class=w> </span><span class=n>authorizationInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleAuthorizationInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//设置相应角色的权限信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SysRole</span><span class=w> </span><span class=n>role</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>managerInfo</span><span class=p>.</span><span class=na>getRoles</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//设置角色</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>authorizationInfo</span><span class=p>.</span><span class=na>addRole</span><span class=p>(</span><span class=n>role</span><span class=p>.</span><span class=na>getRole</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Permission</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>role</span><span class=p>.</span><span class=na>getPermissions</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//设置权限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>authorizationInfo</span><span class=p>.</span><span class=na>addStringPermission</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=na>getPermission</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>authorizationInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在<code>doGetAuthenticationInfo</code>中用户可以自定义抛出很多异常，详情见文档。</p><p><strong>重写Filter</strong></p><p>所有的请求都会先经过Filter，所以我们继承官方的BasicHttpAuthenticationFilter，并且重写鉴权的方法， 另外通过重写preHandle，实现跨越访问。</p><p>代码的执行流程<code>preHandle</code>-><code>isAccessAllowed</code>-><code>isLoginAttempt</code>-><code>executeLogin</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JWTFilter</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>BasicHttpAuthenticationFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 判断用户是否想要登入。
</span></span></span><span class=line><span class=cl><span class=cm>     * 检测header里面是否包含Authorization字段即可
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isLoginAttempt</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>authorization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>authorization</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>executeLogin</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>httpServletRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>authorization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JWTToken</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JWTToken</span><span class=p>(</span><span class=n>authorization</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 提交给realm进行登入，如果错误他会抛出异常并被捕获</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>getSubject</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>).</span><span class=na>login</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果没有抛出异常则代表登入成功，返回true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 这里我们详细说明下为什么最终返回的都是true，即允许访问
</span></span></span><span class=line><span class=cl><span class=cm>     * 例如我们提供一个地址 GET /article
</span></span></span><span class=line><span class=cl><span class=cm>     * 登入用户和游客看到的内容是不同的
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果在这里返回了false，请求会被直接拦截，用户看不到任何东西
</span></span></span><span class=line><span class=cl><span class=cm>     * 所以我们在这里返回true，Controller中可以通过 subject.isAuthenticated() 来判断用户是否登入
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果有些资源只有登入用户才能访问，我们只需要在方法上面加上 @RequiresAuthentication 注解即可
</span></span></span><span class=line><span class=cl><span class=cm>     * 但是这样做有一个缺点，就是不能够对GET,POST等请求进行分别过滤鉴权(因为我们重写了官方的方法)，但实际上对应用影响不大
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isAccessAllowed</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>mappedValue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isLoginAttempt</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>executeLogin</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>response401</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 对跨域提供支持
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>httpServletRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>httpServletResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=p>)</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>httpServletResponse</span><span class=p>.</span><span class=na>setHeader</span><span class=p>(</span><span class=s>&#34;Access-control-Allow-Origin&#34;</span><span class=p>,</span><span class=w> </span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Origin&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>httpServletResponse</span><span class=p>.</span><span class=na>setHeader</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Methods&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;GET,POST,OPTIONS,PUT,DELETE&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>httpServletResponse</span><span class=p>.</span><span class=na>setHeader</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Headers&#34;</span><span class=p>,</span><span class=w> </span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=s>&#34;Access-Control-Request-Headers&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 跨域时会首先发送一个option请求，这里我们给option请求直接返回正常状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getMethod</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>RequestMethod</span><span class=p>.</span><span class=na>OPTIONS</span><span class=p>.</span><span class=na>name</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>httpServletResponse</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>OK</span><span class=p>.</span><span class=na>value</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>preHandle</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 将非法请求跳转到 /401
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>response401</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>resp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>httpServletResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=p>)</span><span class=w> </span><span class=n>resp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>httpServletResponse</span><span class=p>.</span><span class=na>sendRedirect</span><span class=p>(</span><span class=s>&#34;/401&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>编写ShiroConfig配置类</strong></p><p>这里我还增加了EhCache缓存管理支持，不需要每次都调用数据库做授权。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Order</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ShiroConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ShiroFilterFactoryBean 处理拦截资源文件问题。
</span></span></span><span class=line><span class=cl><span class=cm>     * 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在
</span></span></span><span class=line><span class=cl><span class=cm>     * 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager Filter Chain定义说明
</span></span></span><span class=line><span class=cl><span class=cm>     * 1、一个URL可以配置多个Filter，使用逗号分隔
</span></span></span><span class=line><span class=cl><span class=cm>     * 2、当设置多个过滤器时，全部验证通过，才视为通过
</span></span></span><span class=line><span class=cl><span class=cm>     * 3、部分过滤器可指定参数，如perms，roles
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ShiroFilterFactoryBean</span><span class=w> </span><span class=nf>shirFilter</span><span class=p>(</span><span class=n>SecurityManager</span><span class=w> </span><span class=n>securityManager</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ShiroFilterFactoryBean</span><span class=w> </span><span class=n>shiroFilterFactoryBean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShiroFilterFactoryBean</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 必须设置 SecurityManager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shiroFilterFactoryBean</span><span class=p>.</span><span class=na>setSecurityManager</span><span class=p>(</span><span class=n>securityManager</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//验证码过滤器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Filter</span><span class=o>&gt;</span><span class=w> </span><span class=n>filtersMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shiroFilterFactoryBean</span><span class=p>.</span><span class=na>getFilters</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>filtersMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;jwt&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JWTFilter</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shiroFilterFactoryBean</span><span class=p>.</span><span class=na>setFilters</span><span class=p>(</span><span class=n>filtersMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 拦截器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>filterChainDefinitionMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 其他的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>filterChainDefinitionMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;/**&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jwt&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 访问401和404页面不通过我们的Filter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>filterChainDefinitionMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;/401&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;anon&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>filterChainDefinitionMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;/404&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;anon&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shiroFilterFactoryBean</span><span class=p>.</span><span class=na>setFilterChainDefinitionMap</span><span class=p>(</span><span class=n>filterChainDefinitionMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>shiroFilterFactoryBean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityManager</span><span class=w> </span><span class=nf>securityManager</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DefaultWebSecurityManager</span><span class=w> </span><span class=n>securityManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultWebSecurityManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置realm.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>securityManager</span><span class=p>.</span><span class=na>setRealm</span><span class=p>(</span><span class=n>myShiroRealm</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//注入缓存管理器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>securityManager</span><span class=p>.</span><span class=na>setCacheManager</span><span class=p>(</span><span class=n>ehCacheManager</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 关闭shiro自带的session</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DefaultSubjectDAO</span><span class=w> </span><span class=n>subjectDAO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultSubjectDAO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DefaultSessionStorageEvaluator</span><span class=w> </span><span class=n>defaultSessionStorageEvaluator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultSessionStorageEvaluator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>defaultSessionStorageEvaluator</span><span class=p>.</span><span class=na>setSessionStorageEnabled</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subjectDAO</span><span class=p>.</span><span class=na>setSessionStorageEvaluator</span><span class=p>(</span><span class=n>defaultSessionStorageEvaluator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>securityManager</span><span class=p>.</span><span class=na>setSubjectDAO</span><span class=p>(</span><span class=n>subjectDAO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>securityManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 身份认证realm; (这个需要自己写，账号密码校验；权限等)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>MyShiroRealm</span><span class=w> </span><span class=nf>myShiroRealm</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MyShiroRealm</span><span class=w> </span><span class=n>myShiroRealm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MyShiroRealm</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>myShiroRealm</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 开启shiro aop注解支持. 使用代理方式; 所以需要开启代码支持;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param securityManager 安全管理器
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 授权Advisor
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>AuthorizationAttributeSourceAdvisor</span><span class=w> </span><span class=nf>authorizationAttributeSourceAdvisor</span><span class=p>(</span><span class=n>SecurityManager</span><span class=w> </span><span class=n>securityManager</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AuthorizationAttributeSourceAdvisor</span><span class=w> </span><span class=n>authorizationAttributeSourceAdvisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AuthorizationAttributeSourceAdvisor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>authorizationAttributeSourceAdvisor</span><span class=p>.</span><span class=na>setSecurityManager</span><span class=p>(</span><span class=n>securityManager</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>authorizationAttributeSourceAdvisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * shiro缓存管理器;
</span></span></span><span class=line><span class=cl><span class=cm>     * 需要注入对应的其它的实体类中：
</span></span></span><span class=line><span class=cl><span class=cm>     * 1、安全管理器：securityManager
</span></span></span><span class=line><span class=cl><span class=cm>     * 可见securityManager是整个shiro的核心；
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>EhCacheManager</span><span class=w> </span><span class=nf>ehCacheManager</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EhCacheManager</span><span class=w> </span><span class=n>cacheManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EhCacheManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cacheManager</span><span class=p>.</span><span class=na>setCacheManagerConfigFile</span><span class=p>(</span><span class=s>&#34;classpath:ehcache.xml&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>cacheManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>里面URL规则自己参考文档<a class=link href=http://shiro.apache.org/web.html target=_blank rel=noopener>http://shiro.apache.org/web.html</a> ，这个在shiro那篇说的很清楚了。</p><h2 id=运行验证>运行验证</h2><p>最后是将代码跑起来验证这一切是否正常。</p><p>启动SpringBoot后，先通过POST请求登录拿到token</p><p><img src=http://image.tianhui.xin/liveLearn/5/jwt21.png loading=lazy alt=登录拿到token></p><p>然后在调用入网接口的时候在header中带上这个token认证：</p><p><img src=http://image.tianhui.xin/liveLearn/5/jwt22.png loading=lazy alt=token认证></p><p>如果token认证不正确会报异常：</p><p><img src=http://image.tianhui.xin/liveLearn/5/jwt23.png loading=lazy alt=token异常></p><p>如果使用普通用户登录，认证正确但是授权访问接口失败，会返回如下的未授权结果：</p><p><img src=http://image.tianhui.xin/liveLearn/5/jwt24.png loading=lazy alt=授权访问接口失败></p><h2 id=参考文章>参考文章</h2><ul><li><p><a class=link href=http://blog.restcase.com/restful-api-authentication-basics/ target=_blank rel=noopener>RESTful API Authentication Basics</a></p></li><li><p><a class=link href=https://www.jianshu.com/p/576dbf44b2ae target=_blank rel=noopener>什么是 JWT – JSON WEB TOKEN</a></p></li><li><p><a class=link href=https://juejin.im/post/59f1b2766fb9a0450e755993 target=_blank rel=noopener>Shiro+JWT+Spring Boot Restful简易教程</a></p></li></ul><h2 id=github源码>GitHub源码</h2><p><a class=link href=https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-jwt target=_blank rel=noopener>springboot-jwt</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/springboot/>Springboot</a>
<a href=/tags/java/>Java</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/springboot%E4%B8%AD%E4%BD%BF%E7%94%A8springintegration/><div class=article-details><h2 class=article-title>SpringBoot中使用SpringIntegration</h2></div></a></article><article><a href=/p/springboot-%E5%AE%9A%E5%88%B6%E8%87%AA%E5%B7%B1%E7%9A%84starter/><div class=article-details><h2 class=article-title>springBoot 定制自己的starter</h2></div></a></article><article><a href=/p/mybatis%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86/><div class=article-details><h2 class=article-title>mybatis对数据进行加密</h2></div></a></article><article class=has-image><a href=/p/%E8%B7%9F%E6%88%91%E5%AD%A6springcloud-%E4%B9%8B-nacos/><div class=article-image><img src="https://image.tianhui.xin/spring-cloud/nacos.png?x-oss-process=style/make" loading=lazy data-key data-hash="https://image.tianhui.xin/spring-cloud/nacos.png?x-oss-process=style/make"></div><div class=article-details><h2 class=article-title>跟我学SpringCloud 之 nacos</h2></div></a></article><article class=has-image><a href=/p/%E4%B8%80%E8%A7%81%E5%80%BE%E5%BF%83%E4%B9%8B%E5%88%9D%E9%81%87mapstruct/><div class=article-image><img src="https://image.tianhui.xin/mapstruct/Mapstruct.png?x-oss-process=style/make" loading=lazy data-key data-hash="https://image.tianhui.xin/mapstruct/Mapstruct.png?x-oss-process=style/make"></div><div class=article-details><h2 class=article-title>一见倾心之初遇MapStruct</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//codly.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2024 Codly</section><section class=running-time>本博客已稳定运行
<span id=runningdays class=running-days></span></section><section class=totalcount>发表了26篇文章 ·
总计11.63k字</section><section class=powerby>ICP证：<a href=http://www.beian.miit.gov.cn>京16046477</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.0cfc05a2fb3e93f4fdb0c9e18b6a4c98cb32316def8db6fc5b2a1522bc17af8c.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>let s1="2023-3-18";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小时"+minutes+"分钟";document.getElementById("runningdays").innerHTML=result</script></body></html>